<plugin id="Ex01VideoTracking" version="@DASH_VERSION@">

    <requirement id="dataReg" />
    <requirement id="servicesReg" />
    <requirement id="visuVTKQt" />
    <requirement id="tracker" />
    <requirement id="trackerAruco" />
    <requirement id="arMedia" />

    <extension implements="::fwServices::registry::AppConfig2">
        <id>Ex01VideoTrackingConfig</id>
        <config>

            <object uid="camera" type="::arData::Camera" />
            <object uid="frameTL" type="::arData::FrameTL">
                <value>100</value>
            </object>
            <object uid="tagTL" type="::arData::MarkerTL" />
            <object uid="videoImage" type="::fwData::Image" />

            <service uid="mainFrame" type="::gui::frame::SDefaultFrame" >
                <gui>
                    <frame>
                        <name>Ex01VideoTracking</name>
                        <icon>@BUNDLE_PREFIX@/Ex01VideoTracking_0-1/videotracking.ico</icon>
                    </frame>
                    <toolBar />
                </gui>
                <registry>
                    <toolBar sid="toolbar" start="yes" />
                    <view sid="cameraView" start="yes" />
                </registry>
            </service>

            <service uid="toolbar" type="::gui::aspect::SDefaultToolBar" >
                <gui>
                    <layout>
                        <editor />
                        <menuItem name="start" icon="@BUNDLE_PREFIX@/arMedia_0-1/icons/start-cam.svg" />
                        <menuItem name="stop" icon="@BUNDLE_PREFIX@/arMedia_0-1/icons/stop-cam.svg" />
                        <menuItem name="pause" icon="@BUNDLE_PREFIX@/arMedia_0-1/icons/pause-cam.svg" />
                    </layout>
                </gui>
                <registry>
                    <editor sid="CameraSelector" start="yes" />
                    <menuItem sid="startVideo" start="yes" />
                    <menuItem sid="stopVideo" start="yes" />
                    <menuItem sid="pauseVideo" start="yes" />
                </registry>
            </service>

            <service uid="startVideo" type="::gui::action::SSlotCaller" >
                <slots>
                    <slot>frameGrabber/startCamera</slot>
                </slots>
            </service>

            <service uid="stopVideo" type="::gui::action::SSlotCaller" >
                <slots>
                    <slot>frameGrabber/stopCamera</slot>
                </slots>
            </service>

            <service uid="pauseVideo" type="::gui::action::SSlotCaller" >
                <slots>
                    <slot>frameGrabber/pauseCamera</slot>
                </slots>
            </service>

            <service uid="cameraView" type="::gui::view::SDefaultView" >
                <gui>
                    <layout type="::fwGui::CardinalLayoutManager">
                        <view align="center" />
                        <view align="right" />
                    </layout>
                </gui>
                <registry>
                    <view sid="genericScene" start="yes" />
                    <view sid="trackingEditor" start="yes" />
                </registry>
            </service>

            <service uid="genericScene" type="::fwRenderVTK::SRender" autoConnect="yes">
                <in key="image" uid="videoImage" />
                <scene>
                    <renderer id="default" background="0.0" />
                    <adaptor id="videoAdapter" class="::visuVTKARAdaptor::SVideoAdapter" objectId="image">
                        <config renderer="default" />
                    </adaptor>
                    <adaptor id="interactorStyle" class="::visuVTKAdaptor::InteractorStyle" objectId="self">
                        <config renderer="default" style="InteractorStyle2DForNegato" />
                    </adaptor>
                </scene>
            </service>

            <service uid="trackingEditor" type="::guiQt::editor::SParameters" autoConnect="yes">
                <parameters>
                    <param type="int" name="Min Win. Adap. Threshold" key="adaptiveThreshWinSizeMin" defaultValue="3" min="0" max="50" />
                    <param type="int" name="Max Win. Adap. Threshold" key="adaptiveThreshWinSizeMax" defaultValue="23" min="0" max="100"/>
                    <param type="int" name="increment from min to max" key="adaptiveThreshWinSizeStep" defaultValue="10" min="1" max="100"/>
                    <param type="double" name="Adap. Thresh Constant" key="adaptiveThreshConstant" defaultValue="7" min="0.0" max="100.0"/>

                    <param type="double" name="Min. Marker Perimeter Rate" key="minMarkerPerimeterRate" defaultValue="0.03" min="0.0" max="100.0"/>
                    <param type="double" name="Max. Marker Perimeter Rate" key="maxMarkerPerimeterRate" defaultValue="4.0" min="0.0" max="100.0"/>

                    <param type="double" name="Poly. Approx. Accuracy Rate" key="polygonalApproxAccuracyRate" defaultValue="1.0" min="0.0" max="100.0"/>

                    <param type="double" name="Min. Corner Dist. Rate" key="minCornerDistanceRate" defaultValue="0.05" min="0.0" max="5.0" />

                    <param type="int" name="Min. Distance to Border" key="minDistanceToBorder" defaultValue="3" min="1" max="100" />

                    <param type="double" name="Min. Marker Dist. Rate" key="minMarkerDistanceRate" defaultValue="0.05" min="0.0" max="5.0" />

                    <param  type="bool" name="Corner Refinement" key="doCornerRefinement" defaultValue="true" />

                    <param type="int" name="Min. Size Corner Ref." key="cornerRefinementWinSize" defaultValue="5" min="1" max="100" />
                    <param type="int" name="Max. Iter. Corner Ref." key="cornerRefinementMaxIterations" defaultValue="30" min="1" max="100" />

                    <param type="double" name="Min. Accuracy Corner Ref." key="cornerRefinementMinAccuracy" defaultValue="0.1" min="0.0" max="5.0" />

                    <param type="int" name="Marker Order Bits" key="markerBorderBits" defaultValue="1" min="1" max="10" />
                    <param type="int" name="Nb. of Bits for each cells" key="perspectiveRemovePixelPerCell" defaultValue="8" min="1" max="100" />

                    <param type="double" name="Margin Width/Cells" key="perspectiveRemoveIgnoredMarginPerCell" defaultValue="0.13" min="0.0" max="5.0"/>
                    <param type="double" name="Max. Nb of err. bits" key="maxErroneousBitsInBorderRate" defaultValue="0.35" min="0.0" max=".0"/>
                    <param type="double" name="Min. Std Dev. in pix. decod." key="minOtsuStdDev" defaultValue="5.0" min="0.0" max="100.0"/>
                    <param type="double" name="Error Corr. Rate" key="errorCorrectionRate" defaultValue="0.6" min="0.0" max="5.0"/>


                </parameters>
            </service>


            <service uid="tracker" type="::trackerAruco::SArucoTracker"  worker="tracking">
                <in key="frameTL" uid="frameTL" autoConnect="yes"/>
                <in key="camera" uid="camera" />
                <inout group="tagTL" >
                    <key uid="tagTL" />
                </inout>
                <config>
                    <track>
                        <marker id="0,1,2,3,4,5,6,7,8,42,100,101,102,103,104,105" />
                    </track>
                    <debugMarkers>yes</debugMarkers>
                </config>
            </service>

            <service uid="synchronizer" type="::videoTools::SFrameMatrixSynchronizer"  worker="videoWorker">
                <in group="frameTL">
                    <key uid="frameTL" />
                </in>
                <inout group="image">
                    <key uid="videoImage" />
                </inout>
                <framerate>30</framerate>
            </service>

            <service uid="CameraSelector" type="::videoQt::editor::SCamera" >
                <inout key="camera" uid="camera" />
                <videoSupport>yes</videoSupport>
            </service>

            <service uid="frameGrabber" type="::videoQt::SFrameGrabber" >
                <in key="camera" uid="camera" />
                <inout key="frameTL" uid="frameTL" />
            </service>

            <connect>
                <signal>camera/idModified</signal>
                <slot>frameGrabber/stopCamera</slot>
            </connect>

            <start uid="mainFrame" />
            <start uid="frameGrabber" />
            <start uid="synchronizer" />
            <start uid="tracker" />

        </config>
    </extension>

</plugin>
